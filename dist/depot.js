"use strict";function toJSON(t){return t&&JSON.parse(t)}function toString(t){return t&&JSON.stringify(t)}function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function guid(){return""+s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}function findMatch(t,e){var r=!0;if("function"==typeof t)r=t(e);else for(var i in t)r&=t[i]===e[i];return r}function getKey(t,e){return t+"-"+e}function depot(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e=Object.assign({name:t,idAttribute:"_id",storageAdaptor:LocalStorageAdaptor},e);return new Depot(t,e)}var classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},possibleConstructorReturn=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},Depot=function(){function t(e,r){classCallCheck(this,t),this.adaptor=new r.storageAdaptor(r)}return createClass(t,[{key:"save",value:function(t){return this.adaptor.save(t)}},{key:"saveAll",value:function(t){var e=this;return t.forEach(function(t){return e.adaptor.save(t)}),this.all()}},{key:"update",value:function(t,e){return this.adaptor.update(t,e)}},{key:"updateAll",value:function(t){return this.adaptor.updateAll(t)}},{key:"find",value:function(t){return this.adaptor.find(t)}},{key:"get",value:function(t){return this.adaptor.get(t)}},{key:"all",value:function(){return this.adaptor.all()}},{key:"destroy",value:function(t){return this.adaptor.destroy(t)}},{key:"destroyAll",value:function(t){return this.adaptor.destroyAll(t)}},{key:"size",value:function(){return this.adaptor.size()}}]),t}(),CoreAdaptor=function(){function t(e){classCallCheck(this,t),this.name=e.name,this.idAttribute=e.idAttribute}return createClass(t,[{key:"update",value:function(t,e){void 0===e&&(t=(e=t)[this.idAttribute]);var r=this.get(t);return r&&this.save(Object.assign(r,e)),r}},{key:"updateAll",value:function(t){var e=this,r=this.all();return r.forEach(function(r){return e.save(Object.assign(r,t))}),r}},{key:"size",value:function(){return this.refresh(),this.ids.length}}]),t}(),util={toJSON:toJSON,guid:guid,findMatch:findMatch,getKey:getKey,toString:toString},LocalStorageAdaptor=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,e);var r=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.storageAdaptor=t.storageType||localStorage,r.refresh(),r}return inherits(e,CoreAdaptor),createClass(e,[{key:"save",value:function(t){this.refresh(),t[this.idAttribute]||(t[this.idAttribute]=util.guid());var e=t[this.idAttribute]+"";if(this.ids.indexOf(e)<0){this.ids.push(e);var r=this.ids.join(",");this.storageAdaptor.setItem(this.name,r),this.store=r}var i=util.getKey(this.name,e);return this.storageAdaptor.setItem(i,util.toString(t)),t}},{key:"find",value:function(t){return this.all(t)}},{key:"get",value:function(t){var e=util.getKey(this.name,t),r=this.storageAdaptor.getItem(e);return util.toJSON(r)}},{key:"all",value:function(t){var e=this;return this.refresh(),this.ids.reduce(function(r,i){var s=util.getKey(e.name,i),n=util.toJSON(e.storageAdaptor.getItem(s));if(!n)return r;if(t){util.findMatch(t,n)&&r.push(n)}else r.push(n);return r},[])}},{key:"destroy",value:function(t){var e=t[this.idAttribute]?t[this.idAttribute]:t,r=util.getKey(this.name,e);t=util.toJSON(this.storageAdaptor.getItem(r)),this.storageAdaptor.removeItem(r);var i=this.ids.indexOf(e+"");return-1!=i&&this.ids.splice(i,1),this.storageAdaptor.setItem(this.name,this.ids.join(",")),t}},{key:"destroyAll",value:function(t){this.refresh();for(var e=this.ids.length-1;e>=0;e--){var r=this.ids[e],i=util.getKey(this.name,r);if(t){var s=util.toJSON(this.storageAdaptor.getItem(i));util.findMatch(t,s)&&(this.storageAdaptor.removeItem(i),this.ids.splice(e,1))}else this.storageAdaptor.removeItem(i)}t?this.storageAdaptor.setItem(this.name,this.ids.join(",")):(this.storageAdaptor.removeItem(this.name),this.ids=[],this.store=null)}},{key:"refresh",value:function(){var t=this.storageAdaptor.getItem(this.name);this.store&&this.store===t||(this.ids=t&&t.split(",")||[],this.store=t)}}]),e}(),MemoryAdaptor=function(t){function e(t){classCallCheck(this,e);var r=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.store=[],r.ids=[],r}return inherits(e,CoreAdaptor),createClass(e,[{key:"save",value:function(t){t[this.idAttribute]||(t[this.idAttribute]=util.guid());var e=t[this.idAttribute];return this.ids.indexOf(e)<0&&(this.store.push(t),this.ids.push(e)),t}},{key:"find",value:function(t){var e=this;return this.ids.reduce(function(r,i,s){var n=e.store[s];if(!n)return r;if(t){util.findMatch(t,n)&&r.push(n)}else r.push(n);return r},[])}},{key:"get",value:function(t){var e=this.ids.indexOf(t);return this.store[e]}},{key:"all",value:function(){return this.store}},{key:"destroy",value:function(t){var e=t[this.idAttribute]?t[this.idAttribute]:t,r=this.ids.indexOf(e);return-1!=r&&(this.ids.splice(r,1),this.store.splice(r,1)),t}},{key:"destroyAll",value:function(t){if(!t)return this.store=[],void(this.ids=[]);for(var e=this.ids.length-1;e>=0;e--){var r=this.store[e];util.findMatch(t,r)&&(this.store.splice(e,1),this.ids.splice(e,1))}}}]),e}(),adaptors=Object.freeze({LocalStorageAdaptor:LocalStorageAdaptor,MemoryAdaptor:MemoryAdaptor,FileAdaptor:LocalStorageAdaptor});depot.adaptors=adaptors,module.exports=depot;
