!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.depot=e()}(this,function(){"use strict";function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function e(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e=Object.assign({name:t,idAttribute:"_id",storageAdaptor:h},e);return new o(t,e)}var i=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),n=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},s=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},o=function(){function t(e,r){i(this,t),this.adaptor=new r.storageAdaptor(r)}return r(t,[{key:"save",value:function(t){return this.adaptor.save(t)}},{key:"saveAll",value:function(t){var e=this;return t.forEach(function(t){return e.adaptor.save(t)}),this.all()}},{key:"update",value:function(t,e){return this.adaptor.update(t,e)}},{key:"updateAll",value:function(t){return this.adaptor.updateAll(t)}},{key:"find",value:function(t){return this.adaptor.find(t)}},{key:"get",value:function(t){return this.adaptor.get(t)}},{key:"all",value:function(){return this.adaptor.all()}},{key:"destroy",value:function(t){return this.adaptor.destroy(t)}},{key:"destroyAll",value:function(t){return this.adaptor.destroyAll(t)}},{key:"size",value:function(){return this.adaptor.size()}}]),t}(),a=function(){function t(e){i(this,t),this.name=e.name,this.idAttribute=e.idAttribute}return r(t,[{key:"update",value:function(t,e){void 0===e&&(t=(e=t)[this.idAttribute]);var i=this.get(t);return i&&this.save(Object.assign(i,e)),i}},{key:"updateAll",value:function(t){var e=this,i=this.all();return i.forEach(function(i){return e.save(Object.assign(i,t))}),i}},{key:"size",value:function(){return this.refresh(),this.ids.length}}]),t}(),u={toJSON:function(t){return t&&JSON.parse(t)},guid:function(){return""+t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},findMatch:function(t,e){var i=!0;if("function"==typeof t)i=t(e);else for(var r in t)i&=t[r]===e[r];return i},getKey:function(t,e){return t+"-"+e},toString:function(t){return t&&JSON.stringify(t)}},h=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var r=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.storageAdaptor=t.storageType||localStorage,r.refresh(),r}return n(e,a),r(e,[{key:"save",value:function(t){this.refresh(),t[this.idAttribute]||(t[this.idAttribute]=u.guid());var e=t[this.idAttribute]+"";if(this.ids.indexOf(e)<0){this.ids.push(e);var i=this.ids.join(",");this.storageAdaptor.setItem(this.name,i),this.store=i}var r=u.getKey(this.name,e);return this.storageAdaptor.setItem(r,u.toString(t)),t}},{key:"find",value:function(t){return this.all(t)}},{key:"get",value:function(t){var e=u.getKey(this.name,t),i=this.storageAdaptor.getItem(e);return u.toJSON(i)}},{key:"all",value:function(t){var e=this;return this.refresh(),this.ids.reduce(function(i,r){var n=u.getKey(e.name,r),s=u.toJSON(e.storageAdaptor.getItem(n));if(!s)return i;if(t){u.findMatch(t,s)&&i.push(s)}else i.push(s);return i},[])}},{key:"destroy",value:function(t){var e=t[this.idAttribute]?t[this.idAttribute]:t,i=u.getKey(this.name,e);t=u.toJSON(this.storageAdaptor.getItem(i)),this.storageAdaptor.removeItem(i);var r=this.ids.indexOf(e+"");return-1!=r&&this.ids.splice(r,1),this.storageAdaptor.setItem(this.name,this.ids.join(",")),t}},{key:"destroyAll",value:function(t){this.refresh();for(var e=this.ids.length-1;e>=0;e--){var i=this.ids[e],r=u.getKey(this.name,i);if(t){var n=u.toJSON(this.storageAdaptor.getItem(r));u.findMatch(t,n)&&(this.storageAdaptor.removeItem(r),this.ids.splice(e,1))}else this.storageAdaptor.removeItem(r)}t?this.storageAdaptor.setItem(this.name,this.ids.join(",")):(this.storageAdaptor.removeItem(this.name),this.ids=[],this.store=null)}},{key:"refresh",value:function(){var t=this.storageAdaptor.getItem(this.name);this.store&&this.store===t||(this.ids=t&&t.split(",")||[],this.store=t)}}]),e}(),d=function(t){function e(t){i(this,e);var r=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.store=[],r.ids=[],r}return n(e,a),r(e,[{key:"save",value:function(t){t[this.idAttribute]||(t[this.idAttribute]=u.guid());var e=t[this.idAttribute];return this.ids.indexOf(e)<0&&(this.store.push(t),this.ids.push(e)),t}},{key:"find",value:function(t){var e=this;return this.ids.reduce(function(i,r,n){var s=e.store[n];if(!s)return i;if(t){u.findMatch(t,s)&&i.push(s)}else i.push(s);return i},[])}},{key:"get",value:function(t){var e=this.ids.indexOf(t);return this.store[e]}},{key:"all",value:function(){return this.store}},{key:"destroy",value:function(t){var e=t[this.idAttribute]?t[this.idAttribute]:t,i=this.ids.indexOf(e);return-1!=i&&(this.ids.splice(i,1),this.store.splice(i,1)),t}},{key:"destroyAll",value:function(t){if(!t)return this.store=[],void(this.ids=[]);for(var e=this.ids.length-1;e>=0;e--){var i=this.store[e];u.findMatch(t,i)&&(this.store.splice(e,1),this.ids.splice(e,1))}}}]),e}(),f=Object.freeze({LocalStorageAdaptor:h,MemoryAdaptor:d,FileAdaptor:h});return e.adaptors=f,e});
